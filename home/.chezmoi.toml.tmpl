{{- $interactive := stdinIsATTY -}}

{{- /*
  Environment Detection Variables
  ===============================
  These variables detect the type of environment chezmoi is running in.
  They are exposed in [data] section for use in other templates.

  - ephemeral: true for cloud/container environments (Codespaces, Docker, Vagrant, etc.)
               Use to skip expensive operations or persistent state
  - headless:  true when no display available or connected via SSH
               Use to skip GUI-related scripts and configurations
  - personal:  true if this machine should have personal secrets (currently unused)
               Reserved for future use to control sensitive data deployment
*/ -}}
{{- $ephemeral := false -}}
{{- $personal := false -}}
{{- $headless := or (env "SSH_CLIENT" | not | not) (not (or (env "DISPLAY") (env "WAYLAND_DISPLAY"))) -}}

{{- $osID := .chezmoi.os -}}
{{- if (and (eq .chezmoi.os "linux") (hasKey .chezmoi.osRelease "id")) -}}
    {{-   $osID = printf "%s-%s" .chezmoi.os .chezmoi.osRelease.id -}}
{{- end -}}

{{/* detect GitHub codespaces, VSCode remote containers, Docker containers, Multipass VMs, and Vagrant boxes */}}
{{- if or (env "CODESPACES") (env "REMOTE_CONTAINERS_IPC") (eq .chezmoi.username "root" "ubuntu" "vagrant" "vscode") -}}
    {{-   $ephemeral = true -}}
    {{-   $headless = true -}}
{{- end -}}

{{/* work around unreliable hostname on darwin */}}
{{- $hostname := .chezmoi.hostname -}}
{{- if eq .chezmoi.os "darwin" -}}
{{-   $hostname = output "scutil" "--get" "LocalHostName" | trim -}}
{{- end -}}

{{- if $interactive -}}
{{-   writeToStdout "ðŸ’¡ Tip: you can re-enter your data with `chezmoi init --data=false`.\n" -}}
{{- end -}}

{{- $class := promptStringOnce . "machine_class" "Machine class (Personal/Work)" -}}
{{- $passphrase := keyring "chezmoi" "gpg-passphrase" -}}

{{- $work := eq $class "Work" -}}

{{- $email := "lecoqjacob@gmail.com" -}}
{{- if $work -}}
{{-   $email = "jacob.lecoq.ext@bayer.com" -}}
{{- end -}}

{{/* encryption = "gpg"
[gpg]
    symmetric = true
    recipient = "33EC7B08ED47E6E3"
    args = ["--batch", "--passphrase", {{ $passphrase | quote }}, "--no-symkey-cache"] */}}

encryption = "age"
[age]
    identity = "~/.config/chezmoi/key.txt"
    recipient = "age16jyvklu7cs0ru087d8z2zv8jwsj2dmqxgs3gu7jycgc9p8gh3qcs6hh6zl"

[data]
    osid = {{ $osID | quote }}
    email = {{ $email | quote }}
    class = {{ $class | quote }}
    headless = {{ $headless }}
    ephemeral = {{ $ephemeral }}
    signingkey = "75514B13ECEAA46F3FBADF5333EC7B08ED47E6E3"

[bitwarden]
    command = "bw"

[diff]
    exclude = ["scripts"]

[status]
    exclude = ["scripts"]
