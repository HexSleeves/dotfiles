{{- if eq .chezmoi.os "linux" -}}
#!/bin/sh

# Setup Tailscale on Linux
# Enables Tailscale with SSH support

set -eu

ADVERTISE_EXIT_NODE="${TAILSCALE_ADVERTISE_EXIT_NODE:-0}"
AUTH_KEY="${TAILSCALE_AUTH_KEY:-}"

echo "Enabling Tailscale..."
if command -v systemctl >/dev/null 2>&1; then
    sudo systemctl enable tailscaled
    sudo systemctl start tailscaled
else
    echo "❌ systemctl not found. Cannot enable tailscaled service."
    exit 1
fi

sleep 1

if [ "$ADVERTISE_EXIT_NODE" = "1" ]; then
    TAILSCALE_ARGS="--ssh --advertise-exit-node"
else
    TAILSCALE_ARGS="--ssh"
fi

if [ -n "$AUTH_KEY" ]; then
    echo "Starting Tailscale with auth key..."
    sudo tailscale up $TAILSCALE_ARGS --auth-key "$AUTH_KEY"
else
    echo "Starting Tailscale..."
    sudo tailscale up $TAILSCALE_ARGS || true
fi

address=$(tailscale ip -4)
echo "Tailscale IPv4 address: $address"

if [ "$ADVERTISE_EXIT_NODE" = "1" ]; then
    NETDEV=$(ip -o route get 8.8.8.8 | cut -f 5 -d " ")
    if command -v ethtool >/dev/null 2>&1; then
        sudo ethtool -K "$NETDEV" rx-udp-gro-forwarding on rx-gro-list off
    fi

    echo "Configuring Tailscale forwarding..."
    sudo tee /etc/sysctl.d/99-tailscale.conf >/dev/null <<'EOF'
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
EOF
    sudo sysctl -p /etc/sysctl.d/99-tailscale.conf
fi

echo "✅ Tailscale setup complete!"
{{- else if eq .chezmoi.os "darwin" -}}
#!/bin/sh

# Setup Tailscale on macOS
# Installs via Homebrew and provides setup instructions

echo "Setting up Tailscale on macOS..."

# Check if tailscale is installed
if ! command -v tailscale >/dev/null 2>&1; then
    echo "Tailscale CLI not found. Installing via Homebrew..."
    if command -v brew >/dev/null 2>&1; then
        # Install the cask (GUI app with CLI)
        brew install --cask tailscale
    else
        echo "Homebrew not found. Please install Tailscale manually:"
        echo "   https://tailscale.com/download/mac"
        exit 1
    fi
fi

# Check if Tailscale app is running
if ! pgrep -x "Tailscale" >/dev/null 2>&1; then
    echo "Opening Tailscale app..."
    open -a Tailscale
    echo ""
    echo "Please complete the following steps in the Tailscale menu bar app:"
    echo "  1. Click the Tailscale icon in the menu bar"
    echo "  2. Click 'Log in' and authenticate with your account"
    echo ""
fi

echo "Once logged in, you can enable SSH access with:"
echo "  tailscale up --ssh"
echo ""
echo "To advertise as an exit node:"
echo "  tailscale up --ssh --advertise-exit-node"
echo ""
echo "Tailscale setup complete!"
{{- end -}}
