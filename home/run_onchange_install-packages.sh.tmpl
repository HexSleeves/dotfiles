#!/usr/bin/env bash
# Bootstrap package installation

set -euo pipefail

ALLOW_UNPINNED_INSTALLERS="${CHEZMOI_ALLOW_UNPINNED_INSTALLERS:-0}"

log() {
    printf '%s\n' "$*"
}

warn() {
    printf 'WARN: %s\n' "$*" >&2
}

install_homebrew_if_missing() {
    if command -v brew >/dev/null 2>&1; then
        log "Homebrew already installed"
        return
    fi

    log "Installing Homebrew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
}

install_mise_if_missing() {
    if command -v mise >/dev/null 2>&1; then
        log "mise already installed"
        return
    fi

    {{ if eq .chezmoi.os "darwin" }}
    if command -v brew >/dev/null 2>&1; then
        log "Installing mise with Homebrew"
        brew install mise
    fi
    {{ else if eq .chezmoi.os "linux" }}
    if command -v apt-get >/dev/null 2>&1; then
        log "Attempting to install mise with apt"
        if ! sudo apt-get install -y mise; then
            warn "mise is not available via apt on this system"
        fi
    fi
    {{ end }}

    if ! command -v mise >/dev/null 2>&1; then
        if [[ "$ALLOW_UNPINNED_INSTALLERS" == "1" ]]; then
            log "Installing mise via official installer script"
            curl -fsSL https://mise.run | sh
        else
            warn "Skipping mise installer script. Set CHEZMOI_ALLOW_UNPINNED_INSTALLERS=1 to allow it."
        fi
    fi
}

install_rustup_if_missing() {
    if command -v rustup >/dev/null 2>&1; then
        [[ -f "{{ .chezmoi.homeDir }}/.cargo/env" ]] && source "{{ .chezmoi.homeDir }}/.cargo/env"
        log "rustup already installed"
        return
    fi

    if [[ "$ALLOW_UNPINNED_INSTALLERS" == "1" ]]; then
        log "Installing rustup"
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        [[ -f "{{ .chezmoi.homeDir }}/.cargo/env" ]] && source "{{ .chezmoi.homeDir }}/.cargo/env"
    else
        warn "Skipping rustup installer script. Set CHEZMOI_ALLOW_UNPINNED_INSTALLERS=1 to allow it."
    fi
}

install_cargo_binstall_if_missing() {
    if ! command -v cargo >/dev/null 2>&1; then
        return
    fi
    if command -v cargo-binstall >/dev/null 2>&1; then
        return
    fi

    log "Installing cargo-binstall with cargo"
    cargo install cargo-binstall
}

log "Bootstrapping packages for '{{ .class }}' profile"

{{ if eq .chezmoi.os "darwin" }}
log "Detected macOS"

if ! command -v git >/dev/null 2>&1; then
    log "Installing Xcode Command Line Tools"
    xcode-select --install
    warn "Complete Xcode Command Line Tools installation, then re-run."
    exit 1
fi

install_homebrew_if_missing

brewfile_target="{{ .chezmoi.homeDir }}/Brewfile"
brewfile_source="{{ .chezmoi.sourceDir }}/home/Brewfile"

if [[ -f "$brewfile_target" ]]; then
    log "Installing packages from $brewfile_target"
    if ! brew bundle install --file="$brewfile_target"; then
        warn "brew bundle failed; continuing bootstrap. Re-run manually with: brew bundle install --file=\"$brewfile_target\""
    fi
elif [[ -f "$brewfile_source" ]]; then
    log "Installing packages from $brewfile_source"
    if ! brew bundle install --file="$brewfile_source"; then
        warn "brew bundle failed; continuing bootstrap. Re-run manually with: brew bundle install --file=\"$brewfile_source\""
    fi
else
    warn "No Brewfile found; skipping brew bundle"
fi
{{ else if eq .chezmoi.os "linux" }}
log "Detected Linux"

if command -v apt-get >/dev/null 2>&1; then
    sudo apt-get update
    sudo apt-get install -y git curl build-essential
elif command -v yum >/dev/null 2>&1; then
    sudo yum install -y git curl
elif command -v pacman >/dev/null 2>&1; then
    sudo pacman -S --noconfirm git curl base-devel
fi
{{ end }}

install_mise_if_missing
install_rustup_if_missing
install_cargo_binstall_if_missing

{{ if eq .chezmoi.os "darwin" }}
if [[ ! -f "{{ .chezmoi.homeDir }}/.fzf.zsh" ]] && brew --prefix fzf >/dev/null 2>&1; then
    fzf_path="$(brew --prefix fzf)"
    "$fzf_path/install" --no-update-rc --completion --key-bindings
fi
{{ end }}

log "Core package installation completed"
